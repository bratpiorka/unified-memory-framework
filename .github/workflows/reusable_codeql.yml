# CodeQL static analysis
name: CodeQL

on: workflow_call

permissions:
  contents: read

env:
  BUILD_DIR : "${{github.workspace}}/build"
  INSTL_DIR : "${{github.workspace}}/../install-dir"

jobs:
  analyze:
    name: Analyze
    permissions:
      security-events: write
    env:
      VCPKG_PATH: "${{github.workspace}}/build/vcpkg/packages/hwloc_x64-windows;${{github.workspace}}/build/vcpkg/packages/tbb_x64-windows;${{github.workspace}}/build/vcpkg/packages/jemalloc_x64-windows"
      PYTHON_PATH: "aa"

    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest]
        include:
          - os: ubuntu-latest
            # Windows doesn't recognize 'CMAKE_BUILD_TYPE', it uses '--config' param in build command
            extra_build_option: '-DCMAKE_BUILD_TYPE=Release'
          - os: windows-latest
    runs-on: ["DSS-CUDA", "DSS-WINDOWS"]

    steps:
    - name: Checkout repository
      uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
      with:
        fetch-depth: 0

    - name: aaa
      run: |
        ls ${{github.workspace}}../../../..
        echo ${{env.PYTHON_PATH}}
        echo "PYTHON_PATH=${{env.PYTHON_PATH}}/python/python.exe" >> $GITHUB_ENV

    - name: bbb
      run: |
        echo ${{env.PYTHON_PATH}}
        
    - name: Check for Python >= 3.10
      id: check_python
      run: |
        echo "python_exists=false" >> $GITHUB_OUTPUT
        $pythonCommand = Get-Command python -ErrorAction SilentlyContinue
        if ($pythonCommand) {
          $pythonVersion = python --version 2>&1
          $versionPattern = 'Python (\d+)\.(\d+)\.(\d+)'
          echo $pythonVersion
          if ($pythonVersion -match $versionPattern) {
            $major = [int]$matches[1]
            $minor = [int]$matches[2]
            if ($major -gt 3 -or ($major -eq 3 -and $minor -ge 10)) {
              echo "python_exists=true" >> $GITHUB_OUTPUT
            } 
          }
        } 
      shell: pwsh
      
